<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>SAM: Software Automatic Mouth</title>
	<link rel="stylesheet" href="samstyle.css">
</head>
<h1>Software Automatic Mouth</h1>
<script src="dist/samjs.js"></script>
<script>
  var opts = {
    debug: 0,
    pitch: 64,
    speed: 72,
    mouth: 128,
    throat: 128
  };

  var lines = [];
  var line = 0;

  document.addEventListener('DOMContentLoaded', function() {
    ['speed', 'pitch', 'mouth', 'throat'].forEach(
      (name) => {
        var e = document.getElementById(name);
        e.onchange = function (e) {
          opts[e.target.id] = 255 - e.target.value;
          document.getElementById(e.target.id + '-lbl').value = 255 - e.target.value;
        };
        e.value = 255 - opts[name];
      }
    );
    ['speed-lbl', 'pitch-lbl', 'mouth-lbl', 'throat-lbl'].forEach(
      (name) => {
        var e = document.getElementById(name);
        e.onchange = function (e) {
		  str = e.target.id.slice(0, -4);
          opts[str] = e.target.value;
          document.getElementById(str).value = 255 - e.target.value;
        };
        e.value = opts[name.slice(0, -4)];
      }
    );	
    document.getElementById('playground').addEventListener('submit', function (e) {
      e.preventDefault();
      var s = new SamJs(opts);
	  parseInputText(0);
    });
    document.getElementById('btndl').addEventListener('click', function (e) {
      e.preventDefault();
	  
	  str = document.getElementById('speechinput').value;
	  if (str.includes("(") && str.includes(")")) {
		var msg = confirm("Due to limitations of the SamJS library, downloaded wave files can only be entirely English input or entirely phonetic input. The input can be split into multiple wave files, following this rule. You will have to use another software program such as Audacity to combine them into one continuous audio file.\n\n\nPress OK to continue with the download, or Cancel to abort.");
		if (msg == false) {
			return;
		}
	  }
	  parseInputText(1);
    });
  });

function parseInputText(dlFlag) {
	inText = document.getElementById('speechinput').value;
	in1 = [];
	in2 = [];
	lines = [];

	for(var i=0; i<inText.length; i++) {
		if (inText[i] === "(") in1.push(i);
	}
	for(var i=0; i<inText.length; i++) {
		if (inText[i] === ")") in2.push(i);
	}
	var strIndex = 0;
	
	for(var i=0; i<in1.length; i++) {
		var q = in1[i]+1;
		var z = in2[i];
		
		obj = {phoneme: 0, text: inText.substring(strIndex, in1[i])};
		lines.push(obj);
		
		strIndex = in2[i]+1;
		
		obj = {phoneme: 1, text: inText.substring(q,z)};
		lines.push(obj);
	}
	
	obj = {phoneme: 0, text: inText.substring(strIndex, inText.length)};
	lines.push(obj);
	
	if (dlFlag == 0) {
		line = 0;
		doSpeech();
	} else if (dlFlag == 1) {
		line = 0;
		doDownload();
	}
}


function doSpeech() {
	if (line===lines.length) {
		line = 0;
		return;
	}
	var chunk = lines[line++];
	var s = new SamJs(opts);
	if (chunk.phoneme == 0) {
		s.speak(chunk.text).then(doSpeech);
	} else if (chunk.phoneme == 1) {
		s.speak(chunk.text, true).then(doSpeech);
	}
}

function doDownload() {
	if (line===lines.length) {
		line = 0;
		return;
	}
	var chunk = lines[line++];
	var s = new SamJs(opts);
	if (chunk.phoneme == 0) {
		s.download(chunk.text);
		doDownload();
	} else if (chunk.phoneme == 1) {
		s.download(chunk.text, true);
		doDownload();
	}
}

function setOpts(spd, pth, mth, thr) {
	var newPitch = 255 - pth;
	document.getElementById('pitch').value = newPitch;
	document.getElementById('pitch-lbl').value = pth;
	opts['pitch'] = pth;
	var newSpeed = 255 - spd;
	document.getElementById('speed').value = newSpeed;
	document.getElementById('speed-lbl').value = spd;
	opts['speed'] = spd;
	var newMouth = 255 - mth;	
	document.getElementById('mouth').value = newMouth;
	document.getElementById('mouth-lbl').value = mth;
	opts['mouth'] = mth;
	var newThroat = 255 - thr;
	document.getElementById('throat').value = newThroat;
	document.getElementById('throat-lbl').value = thr;
	opts['throat'] = thr;
}
</script>
<hr>
<center>
	<p>Type your desired text into the input box below.<br>Wrap <a href="https://github.com/maxpereira/sam/blob/master/docs/manual.md#phonetic-input-to-sam">phonetic input</a> in parentheses.</p>
</center>	
<hr>
<form id="playground">
  <div>
	<textarea id="speechinput" name="textfield" rows="10" cols="60">Hello, my name is SAM, which stands for Software Automatic Mouth.</textarea>

    <input type="submit" class="btn hbtn1" name="Text 1" value="Say"><input type="button" class="btn hbtn2" onclick="document.getElementById('speechinput').value='';" value="Clear">
  <hr>
	<label for="speed" class="sliderLbl">Speed</label>	
    <input type="range" id="speed" min="0" max="254" />
	<input type="number" id="speed-lbl" min="1" max="255" /><br>
	<label for="pitch" class="sliderLbl">Pitch</label>
    <input type="range" id="pitch" min="0" max="255" />
	<input type="number" id="pitch-lbl" min="0" max="255" /><br>
	<label for="mouth" class="sliderLbl">Mouth</label>	
    <input type="range" id="mouth" min="0" max="255" />
	<input type="number" id="mouth-lbl" min="0" max="255" /><br>
	<label for="throat" class="sliderLbl">Throat</label>	
    <input type="range" id="throat" min="0" max="255" />
	<input type="number" id="throat-lbl" min="0" max="255" />
  </div>
</form>
<hr>
<center>
	<a href="javascript:void(0);" onclick="setOpts(72, 64, 110, 160)">Elf</a> | 
	<a href="javascript:void(0);" onclick="setOpts(92, 60, 190, 190)">Little Robot</a> | 
	<a href="javascript:void(0);" onclick="setOpts(82, 72, 110, 105)">Stuffy Guy</a> | 
	<a href="javascript:void(0);" onclick="setOpts(82, 32, 145, 145)">Little Old Lady</a> | 
	<a href="javascript:void(0);" onclick="setOpts(100, 64, 150, 200)">Extra-Terrestrial</a>
	<hr>
	<input type="button" class="btn fbtn" onclick="setOpts(72, 64, 128, 128);" value="Reset to Default">
	<input type="button" class="btn fbtn" id="btndl" onclick="dlFlag = true;" value="Download WAV">
</center>
<hr>
<div id="footer">
<center>
	<a href="https://github.com/maxpereira/sam">Repo</a> (Forked from <a href="https://github.com/discordier/sam">discordier</a>) | <a href="./about.html">What is SAM?</a>
</center>
</div>
</body>
</html>
